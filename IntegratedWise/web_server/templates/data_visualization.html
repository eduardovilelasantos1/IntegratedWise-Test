{% extends "base.html" %}
{% block body %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento LoraMesh</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f9;
        }
        .main-content {
            width: 90%;
            max-width: 1200px;
            text-align: center;
            padding: 20px 0;
        }
        h1 { color: #333; margin-bottom: 10px; }
        
        h2.section-title {
            color: #555;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: left;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }

        .charts-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .chart-container {
            flex-grow: 1;
            min-width: 200px;
            max-width: 300px;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }
        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin: 0 0 15px 0;
            font-weight: 600;
        }

        .value-wrapper { display: flex; align-items: baseline; gap: 5px; }
        .value-display { font-size: 3.0rem; font-weight: 700; color: #2c3e50; }
        .unit-display { font-size: 1.2rem; color: #95a5a6; font-weight: 500; }

        /* Barra de sinal */
        .signal-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 5px;
            height: 60px;
            margin-top: 10px;
        }
        .bar {
            width: 12px;
            background-color: #ddd;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        .b1 { height: 20%; }
        .b2 { height: 40%; }
        .b3 { height: 60%; }
        .b4 { height: 80%; }
        .b5 { height: 100%; }

        .online { color: #27ae60; font-weight: bold; }
        .offline { color: #c0392b; font-weight: bold; }
    </style>
</head>

<body>
<div class="main-content">
    <h1>Status do Sistema</h1>

    <!-- ====================== SENSORES ======================== -->
    <h2 class="section-title">Sensores</h2>
    <div class="charts-grid">
        {% for key, data in sensor_config.items() %}
            {% if 'channel' in key %}
            <div class="chart-container">
                <h3>{{ data.get('label', key) }}</h3>
                <div class="value-wrapper">
                    <span id="value_{{ key }}" class="value-display">--</span>
                    <span class="unit-display">{{ data.get('unit', '') }}</span>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- ====================== BATERIA ======================== -->
    <h2 class="section-title">Bateria & Energia</h2>
    <div class="charts-grid">
        {% for key, data in sensor_config.items() %}
            {% if ('battery' in key or 'bat_' in key or 'consumo' in key) 
                  and key != 'battery_instant_current' %}  <!-- REMOVIDO O BLOCO NÃƒO USADO -->
            <div class="chart-container">
                <h3>{{ data.get('label', key) }}</h3>
                <div class="value-wrapper">
                    <span id="value_{{ key }}" class="value-display">--</span>
                    <span class="unit-display">{{ data.get('unit', '') }}</span>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- ====================== COMUNICAÃ‡ÃƒO ======================== -->
    <h2 class="section-title">ComunicaÃ§Ã£o</h2>

    <div class="charts-grid">

        <!-- Tempo sem comunicaÃ§Ã£o -->
        <div class="chart-container">
            <h3>Tempo sem comunicaÃ§Ã£o</h3>
            <div class="value-wrapper">
                <span id="value_comm_time" class="value-display">--</span>
                <span class="unit-display">s</span>
            </div>
            <div id="comm_status" style="margin-top:10px; font-size:1.1rem;">--</div>
        </div>

        <!-- RSSI IDA -->
        <div class="chart-container">
            <h3>ðŸ“¡ RSSI Ida (Intensidade)</h3>
            <div class="value-wrapper">
                <span id="value_rssi_ida" class="value-display">--</span>
                <span class="unit-display">dBm</span>
            </div>

            <div class="signal-bars" id="bars_rssi_ida">
                <div class="bar b1"></div>
                <div class="bar b2"></div>
                <div class="bar b3"></div>
                <div class="bar b4"></div>
                <div class="bar b5"></div>
            </div>
        </div>

        <!-- RSSI VOLTA -->
        <div class="chart-container">
            <h3>ðŸ“¡ RSSI Volta (Intensidade)</h3>
            <div class="value-wrapper">
                <span id="value_rssi_volta" class="value-display">--</span>
                <span class="unit-display">dBm</span>
            </div>

            <div class="signal-bars" id="bars_rssi_volta">
                <div class="bar b1"></div>
                <div class="bar b2"></div>
                <div class="bar b3"></div>
                <div class="bar b4"></div>
                <div class="bar b5"></div>
            </div>
        </div>

        <!-- SNR -->
        <div class="chart-container">
            <h3>ðŸŽ§ SNR Ida / Volta (RuÃ­do)</h3>
            <div class="value-wrapper">
                <span id="value_snr_ida" class="value-display">--</span>
                <span class="unit-display">dB</span>
            </div>

            <div class="value-wrapper" style="margin-top:15px;">
                <span id="value_snr_volta" class="value-display">--</span>
                <span class="unit-display">dB</span>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    function renderSignalBars(containerId, rssi) {
        const bars = document.querySelectorAll(`#${containerId} .bar`);
        bars.forEach(b => b.style.backgroundColor = "#ddd");

        if (rssi === null || rssi === undefined) return;

        let abs = Math.abs(rssi);
        let level = 1;

        if (abs < 120) level = 1;
        if (abs < 110) level = 2;
        if (abs < 100) level = 3;
        if (abs < 90)  level = 4;
        if (abs < 80)  level = 5;

        let color = "#dc3545";
        if (level >= 3) color = "#ffc107";
        if (level >= 4) color = "#28a745";

        for (let i = 0; i < level; i++) bars[i].style.backgroundColor = color;
    }

    function fetchSensorData() {
        fetch('/api/sensor_data')
            .then(r => r.json())
            .then(data => {

                for (const [key, value] of Object.entries(data)) {
                    const el = document.getElementById(`value_${key}`);

                    if (!el) continue;

                    // ===========================
                    // Sensores e bateria = 2 casas
                    // ComunicaÃ§Ã£o = sem casas
                    // ===========================
                    if (key.includes("channel") ||
                        key.includes("battery") ||
                        key.includes("bat_") ||
                        key.includes("consumo")) {

                        if (typeof value === "number")
                            el.textContent = value.toFixed(2);
                        else
                            el.textContent = value;

                    } else {
                        // ComunicaÃ§Ã£o (comm_time, rssi, snr...)
                        el.textContent = value;
                    }
                }

                // Status online/offline
                const comm = data["comm_time"];
                const stEl = document.getElementById("comm_status");

                if (comm < 60) {
                    stEl.textContent = "ðŸŸ¢ ONLINE";
                    stEl.className = "online";
                } else {
                    stEl.textContent = "ðŸ”´ OFFLINE";
                    stEl.className = "offline";
                }

                // Barras
                renderSignalBars("bars_rssi_ida", data["rssi_ida"]);
                renderSignalBars("bars_rssi_volta", data["rssi_volta"]);

            })
            .catch(err => console.error("ERR:", err));
    }

    setInterval(fetchSensorData, 2000);
    fetchSensorData();
});
</script>

</body>
{% endblock %}
