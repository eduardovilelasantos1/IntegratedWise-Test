{% extends "base.html" %}

{% block title %}Configuração de Relés{% endblock %}

{% block body %}
<div class="container">
    <div class="content-card">
        <h2 class="text-center mb-4">Configuração de Alarmes (Relés)</h2>
        <p class="text-center text-muted">Associe cada Relé a um Sensor e defina o limite de disparo.</p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('alarmes') }}">
            <div class="accordion" id="relayAccordion">
                
                {% for i in range(1, 10) %}
                {% set relay_key = 'relay_' ~ i %}
                {% set current = current_alarms.get(relay_key, {}) %}
                {% set active = alarm_status.get(relay_key, false) %}

                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ i }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}">

                            <!-- Indicador de status COM ID (para atualização automática) -->
                            {% if active %}
                                <span id="relay-dot-{{ i }}" style="width:14px; height:14px; background:#28a745; border-radius:50%; display:inline-block; margin-right:8px;"></span>
                            {% else %}
                                <span id="relay-dot-{{ i }}" style="width:14px; height:14px; background:#ccc; border-radius:50%; display:inline-block; margin-right:8px;"></span>
                            {% endif %}

                            <strong>Relé {{ i }}</strong>
                            <span class="text-muted ms-2 small">
                                {% if current.source %}
                                    (Atuando em: {{ sensor_config.get(current.source, {}).get('label', current.source) }})
                                {% else %}
                                    (Desativado)
                                {% endif %}
                            </span>
                        </button>
                    </h2>

                    <div id="collapse{{ i }}" class="accordion-collapse collapse" data-bs-parent="#relayAccordion">
                        <div class="accordion-body bg-light">
                            <div class="row align-items-end">
                                
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Sensor de Disparo:</label>
                                    <select class="form-select sensor-selector" 
                                            name="{{ relay_key }}_source"
                                            data-target-unit="unit-{{ i }}">
                                        <option value="">-- Desativar Relé --</option>
                                        {% for s_key, s_info in sensor_config.items() %}
                                            <option value="{{ s_key }}" 
                                                    data-unit="{{ s_info.get('unit', '') }}"
                                                    {% if current.source == s_key %}selected{% endif %}>
                                                {{ s_info.get('label', s_key) }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome do Alarme:</label>
                                    <input type="text" class="form-control" 
                                           name="{{ relay_key }}_name" 
                                           value="{{ current.get('alarm_name', '') }}" 
                                           placeholder="Ex: Bomba 1">
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Disparo:</label>
                                    <select class="form-select" name="{{ relay_key }}_type">
                                        <option value="high" {% if current.get('type') == 'high' %}selected{% endif %}>Acima de (>=)</option>
                                        <option value="low" {% if current.get('type') == 'low' %}selected{% endif %}>Abaixo de (=<)</option>
                                    </select>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Valor Limite:</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" 
                                               name="{{ relay_key }}_limit" 
                                               value="{{ current.get('limit_real', 0) }}">
                                        <span class="input-group-text" id="unit-{{ i }}">-</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                {% endfor %}
            </div>

            <div class="d-flex justify-content-end mt-4 pb-5">
                <button type="submit" class="btn btn-primary btn-lg">Salvar Configuração de Relés</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function updateUnit(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const unit = selectedOption.getAttribute('data-unit') || '-';
            const targetId = selectElement.getAttribute('data-target-unit');
            const unitSpan = document.getElementById(targetId);
            if(unitSpan) unitSpan.textContent = unit;
        }

        document.querySelectorAll('.sensor-selector').forEach(sel => {
            sel.addEventListener('change', function() {
                updateUnit(this);
            });
            updateUnit(sel);
        });

        //  Atualização automática das bolinhas de status
        function refreshRelayStatus() {
            fetch("/api/alarm_status")
                .then(res => res.json())
                .then(status => {
                    for (let i = 1; i <= 9; i++) {
                        const dot = document.getElementById("relay-dot-" + i);
                        if (!dot) continue;

                        if (status["relay_" + i] === true) {
                            dot.style.background = "#28a745"; // verde
                        } else {
                            dot.style.background = "#ccc"; // cinza
                        }
                    }
                })
                .catch(err => console.log("Erro ao atualizar status:", err));
        }

        // Atualiza a cada 1 segundo
        setInterval(refreshRelayStatus, 1000);
    });
</script>
{% endblock %}
